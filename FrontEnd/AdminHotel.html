<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Hotel Dashboard</title>
    <!-- ======= Styles ====== -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/AdminHotel.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fa-power-off{
            font-size: 22px;
            position: relative;
            bottom: 6px;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
    </style>
</head>

<body>
<!-- =============== Navigation ================ -->
<div class="Container">
    <div class="navigation">
        <ul style="padding-left: 0">
        <li>
            <a href="#">
                        <span class="icon">
                            <img style="width: 262px;height: 66px" src="assets/images/HotelLogo.png">
                        </span>
            </a>
            </li>

            <li>
                <a href="AdminDashBoard.html">
                        <span class="icon">
                            <ion-icon name="home-outline"></ion-icon>
                        </span>
                    <span class="title">Dashboard</span>
                </a>
            </li>

            <li>
                <a href="AdminCustomer.html">
                        <span class="icon">
                            <ion-icon name="people-outline"></ion-icon>
                        </span>
                    <span class="title">Customers</span>
                </a>
            </li>

            <li>
                <a href="AdminHotel.html">
                    <span class="icon">
                        <ion-icon name="business-outline"></ion-icon> <!-- Best for hotels -->
                    </span>
                    <span class="title">Hotels</span>
                </a>
            </li>

            <li>
                <a href="AdminRoom.html">
                        <span class="icon">
                            <ion-icon name="bed-outline"></ion-icon>
                        </span>
                    <span class="title">Rooms</span>
                </a>
            </li>
            <li>
                <a href="#">
            <span class="icon">
                     <ion-icon name="calendar-outline"></ion-icon>
             </span>
                    <span class="title">Bookings</span>
                </a>
            </li>
            <li>
                <a href="AdminPayment.html">
                        <span class="icon">
                            <ion-icon name="card-outline"></ion-icon>
                        </span>
                    <span class="title">Payment</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="logout()">
                        <span class="icon">
                            <i class="fas fa-power-off"></i> <!-- Logout icon -->
                        </span>
                    <span class="title">Sign Out</span>
                </a>
            </li>
        </ul>
    </div>
    <!-- ========================= Main ==================== -->
    <div class="main">
        <div class="topbar">
            <div class="toggle">
                <ion-icon name="menu-outline"></ion-icon>
            </div>

            <div class="user">
<!--                <img src="assets/imgs/customer01.jpg" alt="">-->
            </div>
        </div>
        <div class="Container">
            <h1 style="padding-top: 40px">Hotel Management</h1>
            <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
                <button type="button" class="btn btn-primary" style="border-radius: 5px"
                        data-bs-toggle="modal" data-bs-target="#exampleModal" data-bs-whatever="@mdo"
                >Add Hotel
                </button>
                
                <div class="search-container position-relative">
                    <input type="text" class="form-control" style="height: 40px; width: 300px; border-radius: 10px" 
                           placeholder="Search Hotel" onkeyup="searchHotel()" id="search">
                    <ion-icon name="search-outline" class="position-absolute" 
                              style="right: 10px; top: 10px;"></ion-icon>
                </div>
            </div>
            
            <div class="table-container">
                <table class="table table-hover table-striped">
                    <thead class="table-dark sticky-top">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Location</th>
                        <th>Description</th>
                        <th>Amenities</th>
                        <th>Phone Number</th>
                        <th>Image</th>
                        <th>Actions</th>
                    </tr>
                    </thead>

                    <tbody id="HotelTable">
                    <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add New Hotel Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Add New Hotel</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addHotelForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="name" class="form-label">Hotel Name</label>
                                        <input type="text" class="form-control" id="name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="location" class="form-label">Location</label>
                                        <input type="text" class="form-control" id="location" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="description" class="form-label">Description</label>
                                        <textarea class="form-control" id="description" rows="3"></textarea>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="amenities" class="form-label">Amenities</label>
                                        <input type="text" class="form-control" id="amenities">
                                    </div>
                                    <div class="mb-3">
                                        <label for="PhoneNumber" class="form-label">Phone Number</label>
                                        <input type="text" class="form-control" id="PhoneNumber" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageUpload" class="form-label">Hotel Image</label>
                                        <input type="file" class="form-control" id="imageUpload" accept="image/*">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="btnSave">Save Hotel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Update Hotel Modal -->
        <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="updateModalLabel">Update Hotel</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="updateHotelForm">
                            <input type="hidden" id="Update_hotelId">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="Update_name" class="form-label">Hotel Name</label>
                                        <input type="text" class="form-control" id="Update_name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="Update_location" class="form-label">Location</label>
                                        <input type="text" class="form-control" id="Update_location" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="Update_description" class="form-label">Description</label>
                                        <textarea class="form-control" id="Update_description" rows="3"></textarea>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="Update_amenities" class="form-label">Amenities</label>
                                        <input type="text" class="form-control" id="Update_amenities">
                                    </div>
                                    <div class="mb-3">
                                        <label for="Update_PhoneNumber" class="form-label">Phone Number</label>
                                        <input type="text" class="form-control" id="Update_PhoneNumber" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="Update_imageUpload" class="form-label">Hotel Image</label>
                                        <input type="file" class="form-control" id="Update_imageUpload" accept="image/*">
                                        <div class="mt-2">
                                            <img id="Update_currentImage" src="" class="img-thumbnail" style="max-height: 100px;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="btnUpdate">Update Hotel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<!-- =========== Scripts =========  -->
<script src="./js/AdminDashboard.js"></script>

<!-- ====== ionicons ======= -->
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

<script>
    // Global variables
    let currentHotelId = null;
    let imageUrl = "assets/images/";
    
    $(document).ready(function () {
        // Check authentication
        let token = localStorage.getItem("jwtToken");
        if (!token) {
            alert("You are not logged in!");
            window.location.href = "login.html";
            return;
        }
        
        // Load hotels
        loadHotels();
        
        // Set up event handlers
        $('#btnSave').click(saveHotel);
        $('#btnUpdate').click(updateHotel);
    });
    
    function loadHotels() {
        let token = localStorage.getItem("jwtToken");
        
        $.ajax({
            url: "http://localhost:8080/api/v1/hotels/all",
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`
            },
            success: (hotels) => {
                let table = $('#HotelTable');
                table.empty();

                if (hotels && Array.isArray(hotels)) {
                    hotels.forEach((hotel) => {
                        let image = imageUrl + (hotel.image || 'default.jpg');
                        
                        table.append(`
                            <tr>
                                <td>${hotel.id}</td>
                                <td>${hotel.name}</td>
                                <td>${hotel.location}</td>
                                <td class="text-truncate" style="max-width: 200px;">${hotel.description || ''}</td>
                                <td class="text-truncate" style="max-width: 150px;">${hotel.amenities || ''}</td>
                                <td>${hotel.phoneNumber}</td>
                                <td>
                                    <img src="${image}" width="80" height="80" alt="Hotel Image"
                                    onerror="this.onerror=null; this.src='assets/images/default.jpg';">
                                </td>
                                <td class="action-buttons">
                                    <button type="button" class="btn btn-sm btn-primary"
                                    data-bs-toggle="modal" data-bs-target="#updateModal"
                                    onclick="prepareEdit('${hotel.id}', '${hotel.name}', '${hotel.location}', 
                                    '${hotel.description || ''}', '${hotel.amenities || ''}', 
                                    '${hotel.phoneNumber}', '${hotel.image || ''}')">
                                        Edit
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" 
                                    onclick="confirmDelete('${hotel.id}', '${hotel.name}')">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        `);
                    });
                } else {
                    table.append('<tr><td colspan="8" class="text-center">No hotels found</td></tr>');
                }
            },
            error: (error) => {
                console.error("AJAX Error:", error);
                if (error.status === 403) {
                    alert("You don't have permission to access hotel data.");
                } else {
                    alert("Something went wrong while fetching hotels.");
                }
            }
        });
    }
    
    function saveHotel() {
        let name = $("#name").val().trim();
        let location = $("#location").val().trim();
        let description = $("#description").val().trim();
        let amenities = $("#amenities").val().trim();
        let phoneNumber = $("#PhoneNumber").val().trim();
        let imageInput = $("#imageUpload")[0];
        let fileName = imageInput.files.length > 0 ? imageInput.files[0].name : "default.jpg";

        if (!name || !location || !phoneNumber) {
            alert("Please fill in all the required fields.");
            return;
        }

        let token = localStorage.getItem("jwtToken");
        
        $.ajax({
            url: "http://localhost:8080/api/v1/hotels/save",
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            data: JSON.stringify({
                "name": name,
                "location": location,
                "description": description,
                "amenities": amenities,
                "phoneNumber": phoneNumber,
                "image": fileName
            }),
            success: (savedHotel) => {
                alert("Hotel added successfully");
                $("#exampleModal").modal("hide");
                $("#addHotelForm")[0].reset();
                loadHotels();
            },
            error: (error) => {
                console.error(error);
                if (error.status === 403) {
                    alert("You don't have permission to add hotels.");
                } else {
                    alert("Something went wrong while saving the hotel.");
                }
            }
        });
    }
    
    function prepareEdit(id, name, location, description, amenities, phoneNumber, image) {
        currentHotelId = id;
        
        $("#Update_name").val(name);
        $("#Update_location").val(location);
        $("#Update_description").val(description);
        $("#Update_amenities").val(amenities);
        $("#Update_PhoneNumber").val(phoneNumber);
        
        // Show current image
        let imageSrc = imageUrl + (image || 'default.jpg');
        $("#Update_currentImage").attr("src", imageSrc).on("error", function() {
            $(this).attr("src", "assets/images/default.jpg");
        });
        
        // Clear file input
        $("#Update_imageUpload").val("");
    }
    
    function updateHotel() {
        if (!currentHotelId) {
            alert("No hotel selected for update.");
            return;
        }
        
        let name = $("#Update_name").val().trim();
        let location = $("#Update_location").val().trim();
        let description = $("#Update_description").val().trim();
        let amenities = $("#Update_amenities").val().trim();
        let phoneNumber = $("#Update_PhoneNumber").val().trim();
        let imageInput = document.getElementById("Update_imageUpload");
        let fileName = imageInput.files.length > 0 ? imageInput.files[0].name : $("#Update_currentImage").attr("src").split('/').pop();

        if (!name || !location || !phoneNumber) {
            alert("Please fill in all the required fields.");
            return;
        }

        let token = localStorage.getItem("jwtToken");
        let hotelData = {
            "id": currentHotelId,
            "name": name,
            "location": location,
            "description": description,
            "amenities": amenities,
            "phoneNumber": phoneNumber,
            "image": fileName
        };
        
        $.ajax({
            url: "http://localhost:8080/api/v1/hotels/update/" + currentHotelId,
            method: "PUT",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            data: JSON.stringify(hotelData),
            success: (updatedHotel) => {
                alert("Hotel updated successfully!");
                $("#updateModal").modal("hide");
                loadHotels();
            },
            error: (error) => {
                console.error(error);
                if (error.status === 403) {
                    alert("You don't have permission to update hotels.");
                } else {
                    alert("Something went wrong while updating the hotel.");
                }
            }
        });
    }
    
    function confirmDelete(id, name) {
        if (confirm(`Are you sure you want to delete the hotel "${name}"?`)) {
            deleteHotel(id);
        }
    }
    
    function deleteHotel(id) {
        let token = localStorage.getItem("jwtToken");
        
        $.ajax({
            url: `http://localhost:8080/api/v1/hotels/delete/${id}`,
            method: "DELETE",
            headers: {
                "Authorization": `Bearer ${token}`
            },
            success: (response) => {
                alert("Hotel deleted successfully");
                loadHotels();
            },
            error: (error) => {
                console.error(error);
                if (error.status === 403) {
                    alert("You don't have permission to delete hotels.");
                } else {
                    alert("Something went wrong while deleting the hotel.");
                }
            }
        });
    }
    
    function searchHotel() {
        let input = document.getElementById("search").value.toLowerCase();
        let table = document.getElementById("HotelTable");
        let rows = table.getElementsByTagName("tr");

        for (let i = 0; i < rows.length; i++) {
            let cols = rows[i].getElementsByTagName("td");
            if (cols.length > 0) {
                let hotelName = cols[1].textContent.toLowerCase();
                let hotelLocation = cols[2].textContent.toLowerCase();
                
                if (hotelName.includes(input) || hotelLocation.includes(input)) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        }
    }
    
    function logout() {
        if (confirm("Are you sure you want to logout?")) {
            localStorage.removeItem("jwtToken");
            alert("Logged out successfully");
            window.location.href = "Login.html";
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossOrigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>

</body>
</html>