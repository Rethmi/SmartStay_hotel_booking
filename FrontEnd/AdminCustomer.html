<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responsive Admin Dashboard | Korsat X Parmaga</title>
    <!-- ======= Styles ====== -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/AdminCustomer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            text-align: center;
        }

        .fa-power-off {
            font-size: 22px;
            position: relative;
            bottom: 6px;
        }

        .details .recentOrders {
            position: relative;
            display: grid;
            min-height: 500px;
            background: var(--white);
            padding: 20px;
            box-shadow: 0 7px 25px rgba(0, 0, 0, 0.08);
            border-radius: 20px;
        }

        .details .cardHeader {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .cardHeader h2 {
            font-weight: 600;
            color: var(--blue);
        }

        .cardHeader .btn {
            position: relative;
            padding: 5px 10px;
            background: var(--blue);
            text-decoration: none;
            color: var(--white);
            border-radius: 6px;
        }

        .details table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .details table thead td {
            font-weight: 600;
        }

        .details .recentOrders table tr {
            color: var(--black1);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .details .recentOrders table tr:last-child {
            border-bottom: none;
        }

        .details .recentOrders table tbody tr:hover {
            background: var(--blue);
            color: var(--white);
        }

        .details .recentOrders table tr td {
            padding: 10px;
        }

        .details .recentOrders table tr td:last-child {
            text-align: end;
        }

        .details .recentOrders table tr td:nth-child(2) {
            text-align: end;
        }

        .details .recentOrders table tr td:nth-child(3) {
            text-align: center;
        }

        .profile-img {
            width: 130px;
            height: 130px;
            margin-bottom: 20px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #909daa;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }

        .profile-img:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .add-btn {
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .add-btn:hover {
            background: #218838;
        }

        .form-popup input {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .form-popup button {
            background: #007BFF;
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
        }

        .form-popup button:hover {
            background: #0056b3;
        }
    </style>
</head>

<body>
<div class="Container">
    <!-- Navigation -->
    <div class="navigation">
        <ul style="padding-left: 0">
            <li>
                <a href="#">
                    <span class="icon">
                        <img style="width: 262px;height: 66px" src="assets/images/HotelLogo.png">
                    </span>
                </a>
            </li>
            <li>
                <a href="AdminDashBoard.html">
                    <span class="icon">
                        <ion-icon name="home-outline"></ion-icon>
                    </span>
                    <span class="title">Dashboard</span>
                </a>
            </li>
            <li>
                <a href="AdminCustomer.html">
                    <span class="icon">
                        <ion-icon name="people-outline"></ion-icon>
                    </span>
                    <span class="title">Customers</span>
                </a>
            </li>
            <li>
                <a href="AdminHotel.html">
                    <span class="icon">
                        <ion-icon name="business-outline"></ion-icon>
                    </span>
                    <span class="title">Hotels</span>
                </a>
            </li>
            <li>
                <a href="AdminRoom.html">
                    <span class="icon">
                        <ion-icon name="bed-outline"></ion-icon>
                    </span>
                    <span class="title">Rooms</span>
                </a>
            </li>
            <li>
                <a href="AdminBooking.html">
                    <span class="icon">
                        <ion-icon name="calendar-outline"></ion-icon>
                    </span>
                    <span class="title">Bookings</span>
                </a>
            </li>
            <li>
                <a href="AdminPayment.html">
                    <span class="icon">
                        <ion-icon name="card-outline"></ion-icon>
                    </span>
                    <span class="title">Payment</span>
                </a>
            </li>
            <li>
                <a href="#" onclick="logout()">
                    <span class="icon">
                        <i class="fas fa-power-off"></i>
                    </span>
                    <span class="title">Sign Out</span>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main -->
    <div class="main">
        <div class="topbar">
            <div class="toggle">
                <ion-icon name="menu-outline"></ion-icon>
            </div>
        </div>

        <div class="Container">
            <h1 style="padding-top: 40px">Customer Management</h1>
            <button type="button" class="add-btn" style="margin-top: 38px;margin-right: 10px;border-radius: 5px"
                    data-bs-toggle="modal" data-bs-target="#exampleModal">Add Customer
            </button>
            <label>
                <input type="text" id="search" placeholder="Search customers..." class="form-control">
            </label>
            <div class="container mt-3">
                <table class="table table-hover">
                    <thead>
                    <tr style="border: 2px solid black ">
                        <td>Id</td>
                        <td>Customer Name</td>
                        <td>Email</td>
                        <td>Role</td>
                        <td>Actions</td>
                    </tr>
                    </thead>
                    <tbody id="customerTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Add Customer Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Add New User</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <input type="text" class="form-control" id="username" placeholder="Enter username"
                                       autocomplete="username">
                            </div>
                            <div class="mb-3">
                                <input type="email" class="form-control" id="email" placeholder="Enter email"
                                       autocomplete="email">
                            </div>
                            <div class="mb-3">
                                <input type="password" class="form-control" id="password" placeholder="Enter password"
                                       autocomplete="new-password">
                            </div>
                            <div class="mb-3">
                                <select class="form-select" id="role">
                                    <option value="ADMIN">Admin</option>
                                    <option value="Manager">Manager</option>
                                    <option value="USER">Customer</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="btnSave">Save User</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Update User Modal -->
        <!-- <div class="modal fade" id="updateModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5">Update User Role</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <select class="form-select" id="update_role">
                                    <option value="ADMIN">Admin</option>
                                    <option value="Manager">Manager</option>
                                    <option value="USER">User</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="btnUpdate">Update User</button>
                    </div>
                </div>
            </div>
        </div> -->
        <!-- Update User Modal -->
<div class="modal fade" id="updateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Update User</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="update_username">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="update_email" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="update_role">
                            <option value="ADMIN">Admin</option>
                            <option value="Manager">Manager</option>
                            <option value="USER">User</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="btnUpdate">Update User</button>
            </div>
        </div>
    </div>
</div>

        <!-- Profile Modal -->
        <div class="modal fade" id="profileModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content text-center">
                    <div class="modal-header">
                        <h5 class="modal-title">User Profile</h5>
                    </div>
                    <div class="modal-body">
                        <img id="modalProfilePicture" src="assets/images/default-profile.png" alt="Profile Picture"
                             class="profile-img">
                        <p id="modalUserName">User Name</p>
                        <p id="modalUserEmail">User Email</p>
                        <p id="modalUserRole">User Role</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>

<script src="./js/AdminDashboard.js"></script>

<script>
// let customers = [];

// $(document).ready(function () {
//     let token = localStorage.getItem("jwtToken");
//     if (!token) {
//         alert("You are not logged in!");
//         window.location.href = "login.html";
//         return;
//     }
//     loadCustomers();
//     $("#search").on("input", searchCustomer);
// });

// function loadCustomers() {
//     $.ajax({
//         url: "http://localhost:8080/api/v1/user/getAll",
//         method: "GET",
//         headers: {"Authorization": "Bearer " + localStorage.getItem("jwtToken")},
//         success: (response) => {
//             if (response.code === 200 && response.data) {
//                 customers = response.data;
//                 populateCustomerTable(customers);
//             } else alert("Failed to load customers");
//         },
//         error: (xhr) => {
//             if (xhr.status === 403) alert("Access denied!");
//             else if (xhr.status === 401) {
//                 localStorage.removeItem("jwtToken");
//                 window.location.href = "login.html";
//             } else alert("Error fetching users");
//         }
//     });
// }

// function populateCustomerTable(customersArray) {
//     let table = $('#customerTable');
//     table.empty();
//     if (!customersArray.length) {
//         table.append(`<tr><td colspan="5" class="text-center">No customers found</td></tr>`);
//         return;
//     }
//     let imageUrl = "assets/images/";
//     customersArray.forEach(c => {
//         let image = c.profileImage ? imageUrl + c.profileImage : imageUrl + "default-avatar.jpg";
//         table.append(`
//             <tr>
//                 <td>${c.id || 'N/A'}</td>
//                 <td onclick="openProfileModal('${c.username}', '${c.email}','${image}', '${c.role}')" style="cursor:pointer" data-bs-toggle="modal" data-bs-target="#profileModal">${c.username}</td>
//                 <td onclick="openProfileModal('${c.username}', '${c.email}', '${image}', '${c.role}')" style="cursor:pointer" data-bs-toggle="modal" data-bs-target="#profileModal">${c.email}</td>
//                 <td onclick="openProfileModal('${c.username}', '${c.email}', '${image}', '${c.role}')" style="cursor:pointer" data-bs-toggle="modal" data-bs-target="#profileModal">${c.role}</td>
//                 <td class="text-center">
//                     <button class="btn btn-primary btn-sm me-1" data-bs-toggle="modal" data-bs-target="#updateModal" onclick="prepareEdit('${c.email}', '${c.role}')">Edit</button>
//                     <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${c.email}')">Delete</button>
//                 </td>
//             </tr>
//         `);
//     });
// }

// function searchCustomer() {
//     let query = $("#search").val().trim().toLowerCase();
//     let filtered = customers.filter(c =>
//         (c.username && c.username.toLowerCase().includes(query)) ||
//         (c.email && c.email.toLowerCase().includes(query)) ||
//         (c.role && c.role.toLowerCase().includes(query))
//     );
//     populateCustomerTable(filtered);
// }

// $('#btnSave').click(function () {
//     let username = $("#username").val().trim();
//     let email = $("#email").val().trim();
//     let password = $("#password").val().trim();
//     let role = $("#role").val().trim();
//     if (!username || !email || !password || !role) { alert("All fields are required"); return; }
//     const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
//     if (!emailRegex.test(email)) { alert("Enter valid email"); return; }

//     $.ajax({
//         url: "http://localhost:8080/api/v1/user/register",
//         method: "POST",
//         contentType: "application/json",
//         data: JSON.stringify({username, email, password, role}),
//         success: (res) => {
//             if (res.code === 200) {
//                 alert("User created successfully");
//                 $("#exampleModal").modal("hide");
//                 clearAddForm();
//                 loadCustomers();
//             } else alert("Failed: " + (res.message || "Unknown error"));
//         },
//         error: (xhr) => { console.error(xhr); alert("Error creating user"); }
//     });
// });

// function prepareEdit(email, role) {
//     $("#updateModal").data("userEmail", email);
//     $("#update_role").val(role);
// }

// $("#btnUpdate").click(function () {
//     let email = $("#updateModal").data("userEmail");
//     let role = $("#update_role").val();
//     if (!role) { alert("Role required"); return; }

//     $.ajax({
//         url: "http://localhost:8080/api/v1/user/update/" + email,
//         method: "PUT",
//         headers: {"Authorization": "Bearer " + localStorage.getItem("jwtToken")},
//         contentType: "application/json",
//         data: JSON.stringify({role}),
//         success: (res) => { alert("User role updated"); $("#updateModal").modal("hide"); loadCustomers(); },
//         error: (xhr) => { alert("Error updating user"); console.error(xhr); }
//     });
// });

// function deleteCustomer(email) {
//     if (!confirm("Delete this user?")) return;
//     $.ajax({
//         url: "http://localhost:8080/api/v1/user/delete/" + email,
//         method: "DELETE",
//         headers: {"Authorization": "Bearer " + localStorage.getItem("jwtToken")},
//         success: (res) => { alert("User deleted"); loadCustomers(); },
//         error: (xhr) => { alert("Error deleting user"); console.error(xhr); }
//     });
// }

// function openProfileModal(username, email, image, role) {
//     $("#modalUserName").text(username);
//     $("#modalUserEmail").text(email);
//     $("#modalProfilePicture").attr("src", image);
//     $("#modalUserRole").text(role);
// }

// function clearAddForm() {
//     $("#username").val(""); $("#email").val(""); $("#password").val(""); $("#role").val("USER");
// }

// function logout() {
//     localStorage.removeItem("jwtToken");
//     window.location.href = "Login.html";
// }
 
let users = [];

$(document).ready(function () {
    let token = localStorage.getItem("jwtToken");
    if (!token) {
        alert("You are not logged in!");
        window.location.href = "login.html";
        return;
    }
    loadUsers();
    $("#search").on("input", searchUser);
    
    // Set up event handlers
    $('#btnSave').click(createUser);
    $('#btnUpdate').click(updateUser);
});

function loadUsers() {
    $.ajax({
        url: "http://localhost:8080/api/v1/users/all",
        method: "GET",
        headers: {
            "Authorization": "Bearer " + localStorage.getItem("jwtToken")
        },
        success: (usersData) => {
            users = usersData;
            populateUserTable(users);
        },
        error: (xhr) => {
            console.error("Error:", xhr);
            if (xhr.status === 403) {
                alert("Access denied!");
            } else if (xhr.status === 401) {
                localStorage.removeItem("jwtToken");
                window.location.href = "login.html";
            } else {
                alert("Error fetching users");
            }
        }
    });
}

function populateUserTable(usersArray) {
    let table = $('#customerTable');
    table.empty();
    
    if (!usersArray || usersArray.length === 0) {
        table.append('<tr><td colspan="5" class="text-center">No users found</td></tr>');
        return;
    }
    
    let imageUrl = "assets/images/";
    usersArray.forEach(user => {
        let image = user.profileImage ? imageUrl + user.profileImage : imageUrl + "default-avatar.jpg";
        table.append(`
            <tr>
                <td>${user.id || 'N/A'}</td>
                <td onclick="openProfileModal('${user.username}', '${user.email}', '${image}', '${user.role}')" 
                    style="cursor:pointer" data-bs-toggle="modal" data-bs-target="#profileModal">
                    ${user.username}
                </td>
                <td onclick="openProfileModal('${user.username}', '${user.email}', '${image}', '${user.role}')" 
                    style="cursor:pointer" data-bs-toggle="modal" data-bs-target="#profileModal">
                    ${user.email}
                </td>
                <td onclick="openProfileModal('${user.username}', '${user.email}', '${image}', '${user.role}')" 
                    style="cursor:pointer" data-bs-toggle="modal" data-bs-target="#profileModal">
                    ${user.role}
                </td>
                <td class="text-center">
                    <button class="btn btn-primary btn-sm me-1" data-bs-toggle="modal" 
                        data-bs-target="#updateModal" onclick="prepareEdit('${user.id}', '${user.username}', 
                        '${user.email}', '${user.role}')">
                        Edit
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="confirmDelete('${user.id}', '${user.username}')">
                        Delete
                    </button>
                </td>
            </tr>
        `);
    });
}

function searchUser() {
    let query = $("#search").val().trim().toLowerCase();
    let filtered = users.filter(user =>
        (user.username && user.username.toLowerCase().includes(query)) ||
        (user.email && user.email.toLowerCase().includes(query)) ||
        (user.role && user.role.toLowerCase().includes(query))
    );
    populateUserTable(filtered);
}

function createUser() {
    let username = $("#username").val().trim();
    let email = $("#email").val().trim();
    let password = $("#password").val().trim();
    let role = $("#role").val().trim();
    
    if (!username || !email || !password || !role) {
        alert("All fields are required");
        return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert("Please enter a valid email address");
        return;
    }

    let userData = {
        username: username,
        email: email,
        password: password,
        role: role,
        profileImage: "default-avatar.jpg"
    };

    $.ajax({
        url: "http://localhost:8080/api/v1/users/save",
        method: "POST",
        headers: {
            "Authorization": "Bearer " + localStorage.getItem("jwtToken"),
            "Content-Type": "application/json"
        },
        data: JSON.stringify(userData),
        success: (createdUser) => {
            alert("User created successfully");
            $("#exampleModal").modal("hide");
            clearAddForm();
            loadUsers();
        },
        error: (xhr) => {
            console.error("Error:", xhr);
            alert("Error creating user: " + (xhr.responseJSON?.message || "Unknown error"));
        }
    });
}

function prepareEdit(id, username, email, role) {
    currentUserId = id;
    $("#update_username").val(username);
    $("#update_email").val(email);
    $("#update_role").val(role);
    $("#updateModal").modal("show");
}

function updateUser() {
    if (!currentUserId) {
        alert("No user selected for update");
        return;
    }
    
    let username = $("#update_username").val().trim();
    let email = $("#update_email").val().trim();
    let role = $("#update_role").val().trim();
    
    if (!username || !email || !role) {
        alert("All fields are required");
        return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert("Please enter a valid email address");
        return;
    }

    let userData = {
        username: username,
        email: email,
        role: role
    };

    $.ajax({
        url: "http://localhost:8080/api/v1/users/update" + currentUserId,
        method: "PUT",
        headers: {
            "Authorization": "Bearer " + localStorage.getItem("jwtToken"),
            "Content-Type": "application/json"
        },
        data: JSON.stringify(userData),
        success: (updatedUser) => {
            alert("User updated successfully");
            $("#updateModal").modal("hide");
            loadUsers();
        },
        error: (xhr) => {
            console.error("Error:", xhr);
            alert("Error updating user: " + (xhr.responseJSON?.message || "Unknown error"));
        }
    });
}

function confirmDelete(id, username) {
    if (confirm(`Are you sure you want to delete user "${username}"?`)) {
        deleteUser(id);
    }
}

function deleteUser(id) {
    $.ajax({
        url: "http://localhost:8080/api/v1/users/delete" + id,
        method: "DELETE",
        headers: {
            "Authorization": "Bearer " + localStorage.getItem("jwtToken")
        },
        success: () => {
            alert("User deleted successfully");
            loadUsers();
        },
        error: (xhr) => {
            console.error("Error:", xhr);
            alert("Error deleting user: " + (xhr.responseJSON?.message || "Unknown error"));
        }
    });
}

function openProfileModal(username, email, image, role) {
    $("#modalUserName").text(username);
    $("#modalUserEmail").text(email);
    $("#modalProfilePicture").attr("src", image);
    $("#modalUserRole").text(role);
}

function clearAddForm() {
    $("#username").val("");
    $("#email").val("");
    $("#password").val("");
    $("#role").val("USER");
}

function logout() {
    localStorage.removeItem("jwtToken");
    window.location.href = "Login.html";
}
</script>

</body>
</html>
