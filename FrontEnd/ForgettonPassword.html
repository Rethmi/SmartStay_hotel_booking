<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Forgot Password - SmartStay</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
body {
    background-color:  #1a2a4b;;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
}
.card { width: 420px; }
</style>
</head>
<body>

<div class="card p-4">
  <h4 class="mb-3 text-center">Forgot Password</h4>

  <!-- Step 1: Request OTP -->
  <div id="step-request">
    <div class="mb-3">
      <label>Email</label>
      <input id="fp-email" class="form-control" type="email" placeholder="you@example.com" required>
    </div>
    <button id="btn-request-otp" class="btn btn-primary w-100">Send OTP</button>
  </div>

  <!-- Step 2: Verify OTP & Reset -->
  <div id="step-reset" style="display:none;">
    <div class="mb-3">
      <label>OTP</label>
      <input id="fp-otp" class="form-control" type="text" placeholder="6-digit OTP">
    </div>
    <div class="mb-3">
      <label>New password</label>
      <input id="fp-password" class="form-control" type="password" placeholder="New password">
    </div>
    <div class="mb-3">
      <label>Confirm password</label>
      <input id="fp-confirm" class="form-control" type="password" placeholder="Confirm password">
    </div>
    <div class="d-flex gap-2">
      <button id="btn-verify-reset" class="btn btn-success w-100">Verify & Reset</button>
      <button id="btn-back" class="btn btn-outline-secondary w-100">Back</button>
    </div>
  </div>
</div>

<script>
const API_BASE = "http://localhost:8080/auth"; // ✅ Correct backend base URL

const stepRequest = document.getElementById('step-request');
const stepReset = document.getElementById('step-reset');

// Helper: Show alerts
function showAlert(type, title, text) {
    Swal.fire({ icon: type, title, text });
}

// // Step 1: Send OTP
// document.getElementById('btn-request-otp').addEventListener('click', async () => {
//     const email = document.getElementById('fp-email').value.trim();
//     if (!email) {
//         showAlert('warning', 'Missing Field', 'Please enter your email');
//         return;
//     }

//     try {
//         const res = await fetch(`${API_BASE}/send-otp`, {
//     method: 'POST',
//     headers: { 'Content-Type': 'application/json' },
//     body: JSON.stringify({ email }) // ✅ must be { "email": value }
// });


//         if (!res.ok) {
//             const err = await res.text();
//             throw new Error(err || 'Failed to send OTP');
//         }

//         showAlert('success', 'OTP Sent', 'Check your email for the OTP.');
//         stepRequest.style.display = 'none';
//         stepReset.style.display = 'block';
//     } catch (err) {
//         showAlert('error', 'Error', err.message || 'Could not send OTP');
//     }
// });
// Step 1: Send OTP
document.getElementById('btn-request-otp').addEventListener('click', async () => {
    const email = document.getElementById('fp-email').value.trim();
    if (!email) {
        showAlert('warning', 'Missing Field', 'Please enter your email');
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/send-otp`, {   // ✅ change here
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // headers:{"Barer "+token}
            body: JSON.stringify({ email:email })
        });

        if (!res.ok) {
            const err = await res.text();
            throw new Error(err || 'Failed to send OTP');
        }

        showAlert('success', 'OTP Sent', 'Check your email for the OTP.');
        stepRequest.style.display = 'none';
        stepReset.style.display = 'block';
    } catch (err) {
        showAlert('error', 'Error', err.message || 'Could not send OTP');
    }
});


// Step 2: Verify OTP & Reset Password
document.getElementById('btn-verify-reset').addEventListener('click', async () => {
    const email = document.getElementById('fp-email').value.trim();
    const otp = document.getElementById('fp-otp').value.trim();
    const password = document.getElementById('fp-password').value;
    const confirm = document.getElementById('fp-confirm').value;

    if (!otp || !password || !confirm) {
        showAlert('warning', 'Missing Fields', 'Please fill out all fields');
        return;
    }
    if (password !== confirm) {
        showAlert('warning', 'Mismatch', 'Passwords do not match');
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/reset-password`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, otp, password })
        });

        if (!res.ok) {
            const err = await res.text();
            throw new Error(err || 'Password reset failed');
        }

        showAlert('success', 'Password Reset', 'You can now log in with your new password.')
            .then(() => window.location.href = '/login.html');
    } catch (err) {
        showAlert('error', 'Error', err.message || 'Could not reset password');
    }
});

// Step Back
document.getElementById('btn-back').addEventListener('click', () => {
    stepReset.style.display = 'none';
    stepRequest.style.display = 'block';
});
</script>


</body>
</html>