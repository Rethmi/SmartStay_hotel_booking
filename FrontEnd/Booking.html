<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Booking</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="./favicon.svg" type="image/svg+xml">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/booking.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
            href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&family=Poppins:wght@400;500;600;700&display=swap"
            rel="stylesheet">
    <style>
        :root {
            --primary-color: #3a86ff;
            --secondary-color: #ff9e01;
            --dark-color: #1a1a2e;
            --light-color: #f8f9fa;
        }
        
        .logo-hotel {
            width: 300px;
            height: 53px;
        }

        ol, ul {
            padding-left: 0rem;
        }

        .booking {
            margin-top: 100px;
        }

        .booking {
            padding: 60px 0;
            text-align: center;
            color: var(--dark-color);
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .booking__container {
            max-width: 1000px;
            margin: 0 auto;
            background: #FFFFFF;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .booking h2 {
            font-size: 32px;
            margin-bottom: 15px;
            color: var(--dark-color);
            font-weight: 700;
        }

        .booking p {
            font-size: 16px;
            margin-bottom: 25px;
            color: #6c757d;
        }

        .booking__form-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 12px;
            color: #333;
            border: 1px solid #e9ecef;
        }

        .form__row {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .form__group {
            flex: 1;
            text-align: left;
            min-width: 250px;
        }

        .form__group label {
            font-weight: 600;
            display: block;
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        .form__group input,
        .form__group select,
        .form__group textarea {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form__group input:focus,
        .form__group select:focus,
        .form__group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.1);
        }

        .form__group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .price-info {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--dark-color);
        }

        .price-highlight {
            color: var(--secondary-color);
            font-size: 24px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 50px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(58, 134, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(58, 134, 255, 0.4);
        }

        .booking-details {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .booking-details h3 {
            margin-bottom: 15px;
            font-weight: 600;
        }

        .booking-details p {
            margin: 5px 0;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Header Styles */
        .header {
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        }
        
        .header-top {
            background: var(--dark-color);
            padding: 10px 0;
        }
        
        .helpline-box {
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .helpline-box:hover {
            color: var(--secondary-color);
        }
        
        /* Footer Styles */
        .footer {
            background: var(--dark-color);
            color: white;
        }
        
        .footer-top {
            padding: 60px 0 30px;
        }
        
        .footer-brand img {
            max-width: 200px;
            margin-bottom: 20px;
        }
        
        .footer-text {
            color: #aaa;
            margin-bottom: 20px;
        }
        
        .contact-title {
            font-weight: 700;
            margin-bottom: 20px;
            color: white;
        }
        
        .contact-text {
            color: #aaa;
            margin-bottom: 20px;
        }
        
        .contact-item {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .contact-item ion-icon {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .contact-link {
            color: #aaa;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .contact-link:hover {
            color: var(--primary-color);
        }
        
        .footer-bottom {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px 0;
        }

        @media (max-width: 768px) {
            .form__row {
                flex-direction: column;
                gap: 0;
            }
            
            .booking__container {
                padding: 20px;
                margin: 20px;
            }
            
            .booking__form-container {
                padding: 20px;
            }
        }
    </style>
</head>

<body id="top">

<!-- HEADER -->
<header class="header" data-header>
    <div class="overlay" data-overlay></div>
    <div class="header-top">
        <div class="container">
            <a href="tel:+01123456790" class="helpline-box">
                <div class="icon-box">
                    <ion-icon name="call-outline"></ion-icon>
                </div>
                <div class="wrapper">
                    <p class="helpline-title">For Further Inquires :</p>
                    <p class="helpline-number">+01 (123) 4567 90</p>
                </div>
            </a>
            <a href="CustomerDashboard.html" class="logo logo-hotel">
                <!-- <img src="./assets/images/colombo.jpeg" alt="Tourly logo" class="logo-hotel"> -->
            </a>
            <div class="header-btn-group">
                <button class="search-btn" aria-label="Search">
                    <ion-icon name="search"></ion-icon>
                </button>
                <button class="nav-open-btn" aria-label="Open Menu" data-nav-open-btn>
                    <ion-icon name="menu-outline"></ion-icon>
                </button>
            </div>
        </div>
    </div>
</header>

<main>
    <article>
        <!-- BOOKING SECTION -->
        <section class="booking">
            <div class="booking__container">
                <h2>Complete Your Booking</h2>
                <p>Please review your details and confirm your reservation</p>

                <div class="booking__form-container">
                    <form id="bookingForm" class="booking__form">
                        <div class="form__row">
                            <div class="form__group">
                                <label for="name">Full Name:</label>
                                <input type="text" id="name" name="name" required placeholder="Enter your full name">
                            </div>

                            <div class="form__group">
                                <label for="email">Email Address:</label>
                                <input type="email" id="email" name="email" required placeholder="Enter your email">
                            </div>
                        </div>

                        <div class="form__row">
                            <div class="form__group">
                                <label for="phone">Phone Number:</label>
                                <input type="tel" id="phone" name="phone" required
                                       placeholder="Enter your phone number">
                            </div>
                        </div>

                        <div class="form__group">
                            <label for="message">Additional Requests:</label>
                            <textarea id="message" name="message" rows="4"
                                      placeholder="Enter any special requests or preferences"></textarea>
                        </div>

                        <div class="booking-details">
                            <h3><i class="fas fa-calendar-check me-2"></i>Booking Summary</h3>
                            <p><strong>Check-in:</strong> <span id="checkinDisplay"></span></p>
                            <p><strong>Check-out:</strong> <span id="checkoutDisplay"></span></p>
                            <p><strong>Duration:</strong> <span id="durationDisplay"></span> nights</p>
                        </div>

                        <div class="form-footer">
                            <p class="price-info">Secure your booking now</p>
                            <button type="submit" id="ConfirmBooking" class="btn btn-primary">
                                <i class="fas fa-lock me-2"></i>Confirm Booking
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- CTA SECTION -->
        <section class="cta" id="contact">
            <div class="container">
                <div class="cta-content">
                    <p class="section-subtitle">Call To Action</p>
                    <h2 class="h2 section-title">Ready For Unforgettable Travel. Remember Us!</h2>
                    <p class="section-text">
                        Experience the best of Sri Lankan hospitality with our curated selection of luxury accommodations.
                    </p>
                </div>
                <button class="btn btn-secondary">Contact Us!</button>
            </div>
        </section>
    </article>
</main>

<!-- FOOTER -->
<footer class="footer">
    <div class="footer-top">
        <div class="container">
            <div class="footer-brand">
                <a href="#" class="logo">
                    <img src="./assets/images/HotelLogo.png" alt="Tourly logo">
                </a>
                <p class="footer-text">
                    Providing exceptional hospitality experiences across Sri Lanka. 
                    Discover comfort, luxury, and authentic Sri Lankan culture.
                </p>
            </div>
            <div class="footer-contact">
                <h4 class="contact-title">Contact Us</h4>
                <p class="contact-text">
                    Feel free to contact and reach us!
                </p>
                <ul>
                    <li class="contact-item">
                        <ion-icon name="call-outline"></ion-icon>
                        <a href="tel:+01123456790" class="contact-link">+01 (123) 4567 90</a>
                    </li>
                    <li class="contact-item">
                        <ion-icon name="mail-outline"></ion-icon>
                        <a href="mailto:info.tourly.com" class="contact-link">SmartHotelBooking@gmail.com</a>
                    </li>
                    <li class="contact-item">
                        <ion-icon name="location-outline"></ion-icon>
                        <address>Sri Lanka</address>
                    </li>
                </ul>
            </div>
            <div class="footer-form">
                <p class="formm-text">
                    Subscribe our newsletter for more updates & news!
                </p>
                <form action="" class="form-wrapper">
                    <input type="email" name="email" class="input-field" placeholder="Enter Your Email" required>
                    <button type="submit" class="btn btn-secondary">Subscribe</button>
                </form>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <div class="container">
            <p class="copyright">
                &copy; 2025 <a href="">Smart Hotel Booking</a>. All rights reserved
            </p>
            <ul class="footer-bottom-list">
                <li>
                    <a href="#" class="footer-bottom-link">Privacy Policy</a>
                </li>
                <li>
                    <a href="#" class="footer-bottom-link">Term & Condition</a>
                </li>
                <li>
                    <a href="#" class="footer-bottom-link">FAQ</a>
                </li>
            </ul>
        </div>
    </div>
</footer>

<a href="#top" class="go-top" data-go-top>
    <ion-icon name="chevron-up-outline"></ion-icon>
</a>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
        
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

<!-- Font Awesome (CSS only, no JS needed) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


<script>
    // SweetAlert notifications
    function showAlert(icon, title, text) {
        Swal.fire({
            icon: icon,
            title: title,
            text: text,
            timer: 3000,
            showConfirmButton: false
        });
    }

    function showConfirmation(title, text, confirmCallback) {
        Swal.fire({
            title: title,
            text: text,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, confirm!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                confirmCallback();
            }
        });
    }

    $(document).ready(function () {
        let token = localStorage.getItem("jwtToken");
        if (!token) {
            showAlert('error', 'Access Denied', 'Please log in first');
            setTimeout(() => {
                window.location.href = "login.html";
            }, 1500);
            return;
        }

        // Display booking dates
        let checkin = localStorage.getItem("checkin");
        let checkout = localStorage.getItem("checkout");
        
        if (checkin && checkout) {
            $("#checkinDisplay").text(new Date(checkin).toLocaleDateString());
            $("#checkoutDisplay").text(new Date(checkout).toLocaleDateString());
            
            const checkinDate = new Date(checkin);
            const checkoutDate = new Date(checkout);
            const days = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));
            $("#durationDisplay").text(days);
        }

        let Userid;
        let roomId;

        // Get roomId from URL
        function getQueryParams() {
            let params = {};
            let queryString = window.location.search.substring(1);
            let regex = /([^&=]+)=([^&]*)/g;
            let match;
            while (match = regex.exec(queryString)) {
                params[decodeURIComponent(match[1])] = decodeURIComponent(match[2]);
            }
            return params;
        }

        let params = getQueryParams();
        roomId = params['roomId'];
        console.log("Room ID:", roomId);

        let email = localStorage.getItem("email");

        if (!email) {
            showAlert('error', 'Authentication Error', 'Please log in again');
            setTimeout(() => {
                window.location.href = "login.html";
            }, 1500);
            return;
        }

        // Fetch user data
        $.ajax({
            url: `http://localhost:8080/api/v1/users/email/${email}`,
            method: "GET",
            headers: {
                "Authorization": `Bearer ${token}`
            },
            success: function (data) {
                console.log("Customer Data:", data);
                if (data) {
                    $("#name").val(data.username || '');
                    $("#email").val(data.email || '');
                    Userid = data.id;
                } else {
                    showAlert('warning', 'Profile Incomplete', 'Please complete your profile information');
                }
            },
            error: function (xhr, status, error) {
                console.log("Error fetching customer:", error);
                showAlert('error', 'Error', 'Failed to load user details');
            }
        });

        // Form submission
        $("#bookingForm").on('submit', function (e) {
            e.preventDefault();

            console.log("Token:", token, "RoomId:", roomId, "UserId:", Userid, "CheckIn:", checkin, "CheckOut:", checkout);

            if (!$("#phone").val() || !$("#name").val() || !$("#email").val()) {
                showAlert('warning', 'Missing Information', 'Please fill in all required fields');
                return;
            }

            // Validate phone number
            const phoneRegex = /^[+]?[0-9]{10,15}$/;
            if (!phoneRegex.test($("#phone").val())) {
                showAlert('warning', 'Invalid Phone', 'Please enter a valid phone number');
                return;
            }

            // Validate email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test($("#email").val())) {
                showAlert('warning', 'Invalid Email', 'Please enter a valid email address');
                return;
            }

            showConfirmation(
                'Confirm Booking', 
                'Are you sure you want to confirm this booking?', 
                function() {
                    // Show loading state
                    Swal.fire({
                        title: 'Processing Booking',
                        text: 'Please wait while we confirm your reservation...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading()
                        }
                    });

                    $.ajax({
                        url: "http://localhost:8080/api/v1/bookings/save",
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${token}`
                        },
                        contentType: "application/json",
                        data: JSON.stringify({
                            roomId: roomId,
                            userId: Userid,
                            checkInDate: checkin,
                            checkOutDate: checkout,
                            phoneNumber: $("#phone").val(),
                            status: "PENDING",
                            email: $("#email").val(),
                            city: "Not specified",
                            specialRequests: $("#message").val()
                        }),
                        success: function(res) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Booking Confirmed!',
                                text: 'Your reservation has been successfully created.',
                                showConfirmButton: true,
                                confirmButtonText: 'View Dashboard'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = "CustomerDashboard.html";
                                }
                            });
                        },
                        error: function(err) {
                            console.error(err);
                            let errorMsg = 'Failed to create booking. ';
                            
                            if (err.status === 400) {
                                errorMsg += 'Invalid data provided.';
                            } else if (err.status === 409) {
                                errorMsg += 'Room is not available for the selected dates.';
                            } else if (err.status === 500) {
                                errorMsg += 'Server error. Please try again later.';
                            } else {
                                errorMsg += 'Please try again.';
                            }
                            
                            showAlert('error', 'Booking Failed', errorMsg);
                        }
                    });
                }
            );
        });

        // Add input validation
        $("#phone").on('input', function() {
            const phone = $(this).val();
            const phoneRegex = /^[+]?[0-9]{0,15}$/;
            if (!phoneRegex.test(phone)) {
                $(this).css('border-color', '#dc3545');
            } else {
                $(this).css('border-color', '#28a745');
            }
        });

        $("#email").on('blur', function() {
            const email = $(this).val();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email && !emailRegex.test(email)) {
                $(this).css('border-color', '#dc3545');
                showAlert('warning', 'Invalid Email', 'Please enter a valid email address');
            } else if (email) {
                $(this).css('border-color', '#28a745');
            }
        });
    });
</script>
</body>
</html>